<style>
  .side-item-container {
    overflow: hidden;
    max-height: 0;
    transition: max-height 260ms ease;
  }

  .side-item-container.is-open {
    max-height: 1000px;
  }

  .arrow {
    display: inline-block;
    transition: transform 200ms ease;
  }

  .arrow.rotate {
    transform: rotate(180deg);
  }

  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
  }

  .online-dot {
    animation: pulse 1.5s infinite ease-in-out;
    display: inline-block;
  }
</style>

<div class="container-fluid side-bar-container">
  <header class="pb-0">
    <a class="navbar-brand">
      <object class="side-logo" data="/dashboard/svg/logo-8.svg" type="image/svg+xml"></object>
    </a>
  </header>

  <!-- Super Admin -->
  <% if (user.role === ROLES.SUPER_ADMIN) { %>
    <p class="side-comment">Admin Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/dashboard"><i class="fas fa-fire mr-1"></i>Dashboard</a></li>
    </ul>

    <p class="side-comment">Companies</p>
    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-building mr-1"></i>Companies <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container animated">
        <li class="side-item"><a href="/sadmin/companies"><i class="fas fa-angle-right mr-2"></i>All Companies</a></li>
        <li class="side-item"><a href="/sadmin/companies/pending"><i class="fas fa-angle-right mr-2"></i>Pending Approval</a></li>
        <li class="side-item"><a href="/sadmin/companies-deleted"><i class="fas fa-angle-right mr-2"></i>Deleted Companies</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-user-shield mr-1"></i>Admins <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container animated">
        <li class="side-item"><a href="/sadmin/admins"><i class="fas fa-angle-right mr-2"></i>Company Admins</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-chart-bar mr-1"></i>Reports <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container animated">
        <li class="side-item"><a href="/sadmin/reports"><i class="fas fa-angle-right mr-2"></i>System Reports</a></li>
        <li class="side-item"><a href="/sadmin/logs"><i class="fas fa-angle-right mr-2"></i>Activity Logs</a></li>
      </div>
    </ul>

    <p class="side-comment">Settings</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/sadmin/settings"><i class="fas fa-cogs mr-1"></i>Platform Settings</a></li>
    </ul>
  <% } %>


  <!-- Admin -->
  <% if (user.role === ROLES.ADMIN) { %>
    <p class="side-comment">Company Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/dashboard"><i class="fas fa-fire mr-1"></i>Dashboard</a></li>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-users mr-1"></i>Employees <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container hide animated">
        <li class="side-item"><a href="/admin/employees/invite"><i class="fas fa-angle-right mr-2"></i>Invite Employee</a></li>
        <li class="side-item"><a href="/admin/employees"><i class="fas fa-angle-right mr-2"></i>All Employees</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-building mr-1"></i>Departments <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container hide animated">
        <li class="side-item"><a href="/admin/departments/new"><i class="fas fa-angle-right mr-2"></i>Add Department</a></li>
        <li class="side-item"><a href="/admin/departments"><i class="fas fa-angle-right mr-2"></i>All Departments</a></li>
        <li class="side-item"><a href="/admin/departments/soft-deleted"><i class="fas fa-angle-right mr-2"></i>Deleted Departments</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-envelope mr-1"></i>Invitations <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container hide animated">
        <li class="side-item"><a href="/admin/invitations/new"><i class="fas fa-angle-right mr-2"></i>Send Invitation</a></li>
        <li class="side-item"><a href="/admin/invitations"><i class="fas fa-angle-right mr-2"></i>All Invitations</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text"><i class="fas fa-comments mr-1"></i>Direct Messages <i class="fas fa-chevron-down arrow"></i></a>
      <div class="side-item-container hide animated">
        <% directMessages.forEach(dm => { %>
          <li class="side-item">
            <a href="/admin/chat/<%= dm.chatId %>">
              <i class="fas fa-user mr-2"></i><%= dm.name %>
              <span class="badge badge-danger"><%= dm.unreadCount || 0 %></span>
            </a>
          </li>
        <% }) %>
        <li class="side-item"><a href="/admin/chats/new"><i class="fas fa-plus mr-2"></i>Start New Chat</a></li>
      </div>
    </ul>

    <ul class="side a-collapse">
      <a class="ul-text">
        <i class="fas fa-circle text-success online-dot mr-1"></i>Online Users
        <i class="fas fa-chevron-down arrow"></i>
      </a>
      <div class="side-item-container hide animated">
        <% onlineUsers.forEach(u => { %>
          <li class="side-item">
            <a href="/admin/profile/<%= u.id %>">
              <i class="fas fa-circle text-success online-dot mr-1" style="font-size:0.7rem;"></i>
              <%= u.name %>
            </a>
          </li>
        <% }) %>
      </div>
    </ul>

    <p class="side-comment">Settings</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/admin/settings"><i class="fas fa-cog mr-1"></i>Company Settings</a></li>
      <li class="side-item"><a href="/admin/profile"><i class="fas fa-user mr-1"></i>My Profile</a></li>
    </ul>
  <% } %>

  <!-- Head of Department -->
  <% if (user.role === ROLES.HEAD_OF_DEPARTMENT) { %>
    <p class="side-comment">Department Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/dashboard"><i class="fas fa-fire mr-1"></i>Dashboard</a></li>
    </ul>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/department/employees"><i class="fas fa-users mr-1"></i>Department Employees</a></li>
    </ul>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/department/projects"><i class="fas fa-project-diagram mr-1"></i>Department Projects</a></li>
    </ul>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/department/conversations"><i class="fas fa-comments mr-1"></i>Department Chats</a></li>
    </ul>
  <% } %>

  <!-- Employee -->
  <% if (user.role === ROLES.EMPLOYEE) { %>
    <p class="side-comment">Employee Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/employee/dashboard"><i class="fas fa-fire mr-1"></i>Dashboard</a></li>
    </ul>

    <p class="side-comment">Direct Messages</p>
    <ul class="side a-collapse">
      <% directMessages.forEach(dm => { %>
        <li class="side-item">
          <a href="/employee/chat/<%= dm.chatId %>">
            <i class="fas fa-user mr-2"></i><%= dm.name %>
          </a>
        </li>
      <% }) %>
      <li class="side-item"><a href="/employee/chats/new"><i class="fas fa-plus mr-2"></i>Start New Chat</a></li>
    </ul>

    <p class="side-comment">Online Users</p>
    <ul class="side a-collapse">
      <% onlineUsers.forEach(u => { %>
        <li class="side-item">
          <a href="/employee/profile/<%= u.id %>">
            <i class="fas fa-circle text-success online-dot mr-1" style="font-size:0.7rem;"></i>
            <%= u.name %>
          </a>
        </li>
      <% }) %>
    </ul>

    <p class="side-comment">My Department</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/employee/my-department"><i class="fas fa-users mr-1"></i>My Department</a></li>
    </ul>

    <p class="side-comment">Profile</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/employee/profile"><i class="fas fa-user mr-1"></i>My Profile</a></li>
    </ul>
  <% } %>

  <!-- Project Manager -->
  <% if (user.role === ROLES.PROJECT_MANAGER) { %>
    <p class="side-comment">Project Manager Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/dashboard"><i class="fas fa-fire mr-1"></i>Dashboard</a></li>
    </ul>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/projects/assigned"><i class="fas fa-project-diagram mr-1"></i>My Projects</a></li>
    </ul>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/conversations/project"><i class="fas fa-comments mr-1"></i>Project Chats</a></li>
    </ul>
  <% } %>

  <!-- Guest -->
  <% if (user.role === ROLES.GUEST) { %>
    <p class="side-comment">Guest Panel</p>
    <ul class="side a-collapse short">
      <li class="side-item"><a href="/conversations/invited"><i class="fas fa-comments mr-1"></i>Invited Chats</a></li>
      <li class="side-item"><a href="/projects/invited"><i class="fas fa-project-diagram mr-1"></i>Invited Projects</a></li>
    </ul>
  <% } %>

</div>



<script>
document.addEventListener("DOMContentLoaded", function () {
  const collapses = document.querySelectorAll(".a-collapse");

  function closeContainer(container, arrow) {
    container.style.maxHeight = container.scrollHeight + "px";
    setTimeout(() => {
      container.style.maxHeight = "0px";
      container.classList.remove("is-open");
      if (arrow) arrow.classList.remove("rotate");
      container.setAttribute("aria-hidden", "true");
    }, 1);
  }

  function openContainer(container, arrow) {
    container.style.maxHeight = container.scrollHeight + "px";
    container.classList.add("is-open");
    if (arrow) arrow.classList.add("rotate");
    container.setAttribute("aria-hidden", "false");
  }

  collapses.forEach(c => {
    const header = c.querySelector(".ul-text");
    const container = c.querySelector(".side-item-container");
    const arrow = c.querySelector(".arrow");

    if (container && header) {
      container.style.overflow = "hidden";
      container.style.maxHeight = "0px";
      container.setAttribute("aria-hidden", "true");

      header.style.cursor = "pointer";
      header.setAttribute("role", "button");
      header.setAttribute("aria-expanded", "false");

      header.addEventListener("click", () => {
        const isOpen = container.classList.contains("is-open");

        // أغلق كل القوائم الأخرى قبل فتح الحالية
        collapses.forEach(other => {
          const otherContainer = other.querySelector(".side-item-container");
          const otherArrow = other.querySelector(".arrow");
          if (otherContainer && otherContainer !== container) {
            closeContainer(otherContainer, otherArrow);
            const otherHeader = other.querySelector(".ul-text");
            if (otherHeader) otherHeader.setAttribute("aria-expanded", "false");
          }
        });

        if (isOpen) {
          closeContainer(container, arrow);
          header.setAttribute("aria-expanded", "false");
        } else {
          openContainer(container, arrow);
          header.setAttribute("aria-expanded", "true");
        }
      });
    }
  });

  window.addEventListener("resize", () => {
    document.querySelectorAll(".side-item-container.is-open")
      .forEach(container => {
        container.style.maxHeight = container.scrollHeight + "px";
      });
  });
});
</script>