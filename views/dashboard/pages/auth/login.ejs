<!DOCTYPE html>
<html>
  <%- include('../../partials/head.ejs') %>

  <body class="bmd-layout-container bmd-drawer-f-l avam-container">
    <main class="bmd-layout-content">
      <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center">
        <div class="card shadow-lg p-4" style="max-width: 450px; width:100%;">
          <!-- Brand / Logo -->
          <div class="text-center mb-4">
            <img src="/dashboard/svg/logo.svg" alt="Logo" height="130" width="300">
          </div>

          <h4 class="mb-2 text-center">Welcome back ðŸ‘‹</h4>
          <p class="mb-4 text-center">Sign in to your account</p>

          <!-- Login Form -->
          <form id="loginForm" action="/auth/login" method="POST">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control bg-light text-dark" id="email" name="email" required>
              <small class="text-danger error-text" id="error-email"></small>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control bg-light text-dark" id="password" name="password" required>
              <small class="text-danger error-text" id="error-password"></small>
            </div>

            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>

          <p class="text-center mt-3">
            <span>Don't have an account?</span>
            <a href="/auth/register" class="fw-bold">Register here</a>
          </p>

          <!-- Alert Box -->
          <div id="alertBox" class="alert text-center mt-3" style="display:none;"></div>

          <!-- Modal for Company Selection -->
          <div id="companyModal" class="modal" style="display:none;">
            <div class="modal-content p-4" style="max-width:400px; margin:auto; background:#fff; border-radius:8px; overflow:auto;">
              <h5 class="mb-3">Select a Company</h5>
              <div id="companyList" class="mb-3"></div>
              <button id="confirmCompany" class="btn btn-success w-100">Confirm</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <%- include('../../partials/scripts.ejs') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const alertBox = document.getElementById("alertBox");
        const companyModal = document.getElementById("companyModal");
        const companyList = document.getElementById("companyList");
        const confirmCompanyBtn = document.getElementById("confirmCompany");

        let selectedCompanyId = null;
        let loginPayload = {};
        let userId = null;

        const finalizeLogin = async (companyId) => {
          try {
            const body = { userId, companyId };
            const res = await fetch("/auth/login/confirm-company", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body)
            });
            const data = await res.json();

            if (data.success) {
              document.cookie = `token=${data.token}; path=/; max-age=${24*60*60}; HttpOnly`;
              alertBox.className = "alert alert-success text-center mt-3";
              alertBox.textContent = data.message;
              alertBox.style.display = "block";
              setTimeout(() => window.location.href = data.redirect || "/dashboard", 1000);
            } else {
              alertBox.className = "alert alert-danger text-center mt-3";
              alertBox.textContent = data.message || "Login failed";
              alertBox.style.display = "block";
            }
          } catch (err) {
            console.error(err);
            alertBox.className = "alert alert-danger text-center mt-3";
            alertBox.textContent = "Something went wrong. Please try again.";
            alertBox.style.display = "block";
          }
        };

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          alertBox.style.display = "none";
          document.querySelectorAll(".error-text").forEach(el => el.textContent = "");

          loginPayload = {
            email: form.email.value.trim(),
            password: form.password.value
          };

          try {
            const res = await fetch("/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(loginPayload)
            });
            const data = await res.json();

            // Field validation errors
            if (data.errors) {
              data.errors.forEach(err => {
                const fieldError = document.getElementById("error-" + err.path.replace(/[^a-zA-Z0-9]/g,''));
                if (fieldError) fieldError.textContent = err.msg;
              });
              alertBox.className = "alert alert-danger text-center mt-3";
              alertBox.textContent = "Please fix the errors below.";
              alertBox.style.display = "block";
              return;
            }

            // Multiple companies
            if (data.userCompanies && data.userCompanies.length > 1) {
              userId = data.userCompanies[0].userId; // assume all have same userId
              companyList.innerHTML = "";
              data.userCompanies.forEach(uc => {
                const radio = document.createElement("div");
                radio.className = "form-check mb-2";
                radio.innerHTML = `
                  <input class="form-check-input" type="radio" name="selectedCompany" id="${uc.company._id}" value="${uc.company._id}">
                  <label class="form-check-label" for="${uc.company._id}">${uc.company.name} (${uc.role})</label>
                `;
                companyList.appendChild(radio);
              });
              companyModal.style.display = "flex";
              return;
            }

            // Single company / immediate login
            if (data.token) {
              document.cookie = `token=${data.token}; path=/; max-age=${24*60*60}; HttpOnly`;
              alertBox.className = "alert alert-success text-center mt-3";
              alertBox.textContent = "Login successful!";
              alertBox.style.display = "block";
              setTimeout(() => window.location.href = "/dashboard", 1000);
            }

          } catch (err) {
            console.error(err);
            alertBox.className = "alert alert-danger text-center mt-3";
            alertBox.textContent = "Something went wrong. Please try again.";
            alertBox.style.display = "block";
          }
        });

        // Confirm company selection
        confirmCompanyBtn.addEventListener("click", () => {
          const selectedRadio = document.querySelector('input[name="selectedCompany"]:checked');
          if (!selectedRadio) return alert("Please select a company");
          selectedCompanyId = selectedRadio.value;
          companyModal.style.display = "none";
          finalizeLogin(selectedCompanyId);
        });
      });
    </script>

    <style>
      .error-text { font-size: 0.85rem; }
      .form-control:focus { box-shadow: none; }
      .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
      .modal-content { max-width: 400px; margin:auto; background:#fff; border-radius:8px; overflow:auto; }
    </style>
  </body>
</html>
