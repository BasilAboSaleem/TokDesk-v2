<!DOCTYPE html>
<html
  lang="en"
  class="dark-style customizer-hide"
  dir="ltr"
  data-theme="dark"
  data-assets-path="dashboard/assets/"
  data-template="vertical-menu-template-free"
>
  <%- include('../../partials/head.ejs') %>

  <body style="background-color: #121212;">
    <div class="authentication-wrapper authentication-basic min-vh-100 d-flex align-items-center justify-content-center">
      <div class="authentication-inner w-100" style="max-width: 400px;">
        <div class="card shadow-lg" style="background-color: #1e1e1e; color: #ffffff;">
          <div class="app-brand justify-content-center mb-4">
            <a href="/" class="app-brand-link gap-2 text-white">
              <span class="app-brand-text demo fw-bolder">TokDesk</span>
            </a>
          </div>

          <h4 class="mb-2 text-center">Welcome back üëã</h4>
          <p class="mb-4 text-center">Sign in to your account</p>

          <!-- Login Form -->
          <form id="loginForm" class="mb-3" action="/auth/login" method="POST">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control bg-dark text-white border-secondary" id="email" name="email" required />
              <small class="text-danger error-text" id="error-email"></small>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control bg-dark text-white border-secondary" id="password" name="password" required />
              <small class="text-danger error-text" id="error-password"></small>
            </div>

            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>

          <p class="text-center mt-3 text-white">
            <span>Don't have an account?</span>
            <a href="/auth/register-company" class="fw-bold text-white">Register here</a>
          </p>

          <div id="alertBox" class="alert text-center mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>

    <%- include('../../partials/scripts.ejs') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const alertBox = document.getElementById("alertBox");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          alertBox.style.display = "none";
          document.querySelectorAll(".error-text").forEach(el => (el.textContent = ""));

          const formData = new FormData(form);

          try {
            const res = await fetch("/auth/login", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            // Handle validation errors
            if (data.errors && Array.isArray(data.errors)) {
              data.errors.forEach(err => {
                const safePath = err.path.replace(/\./g, '').replace(/\[/g, '').replace(/\]/g, '').replace(/[^a-zA-Z0-9]/g, '');
                const fieldError = document.getElementById("error-" + safePath);
                if (fieldError) fieldError.textContent = err.msg;
              });

              alertBox.className = "alert alert-danger text-center mt-3";
              alertBox.textContent = "Please fix the errors below.";
              alertBox.style.display = "block";
              return;
            }

            // Handle successful login
            if (data.success) {
              alertBox.className = "alert alert-success text-center mt-3";
              alertBox.textContent = data.message;
              alertBox.style.display = "block";

              setTimeout(() => {
                window.location.href = data.redirect || "/dashboard";
              }, 1000);
              return;
            }

            alertBox.className = "alert alert-warning text-center mt-3";
            alertBox.textContent = "Unexpected response from server.";
            alertBox.style.display = "block";

          } catch (error) {
            console.error("‚ùå Fetch error:", error);
            alertBox.className = "alert alert-danger text-center mt-3";
            alertBox.textContent = "Something went wrong. Please try again.";
            alertBox.style.display = "block";
          }
        });
      });
    </script>

    <style>
      .error-text { font-size: 0.85rem; }
      .form-control:focus { box-shadow: none; }
    </style>
  </body>
</html>
