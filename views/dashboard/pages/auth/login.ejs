<!DOCTYPE html>
<html>
  <%- include('../../partials/head.ejs') %>

  <body class="bmd-layout-container bmd-drawer-f-l avam-container">
    <main class="bmd-layout-content">
      <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center">
        <div class="card shadow-lg p-4" style="max-width: 450px; width:100%;">
          <!-- Brand / Logo -->
          <div class="text-center mb-4">
            <img src="/dashboard/svg/logo.svg" alt="Logo" height="130" width="300">
          </div>

          <h4 class="mb-2 text-center">Welcome back üëã</h4>
          <p class="mb-4 text-center">Sign in to your account</p>

          <!-- Login Form -->
          <form id="loginForm" action="/auth/login" method="POST">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control bg-light text-dark" id="email" name="email" required>
              <small class="text-danger error-text" id="error-email"></small>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control bg-light text-dark" id="password" name="password" required>
              <small class="text-danger error-text" id="error-password"></small>
            </div>

            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>

          <p class="text-center mt-3">
            <span>Don't have an account?</span>
            <a href="/auth/register-company" class="fw-bold">Register here</a>
          </p>

          <div id="alertBox" class="alert text-center mt-3" style="display:none;"></div>
        </div>
      </div>
    </main>

    <%- include('../../partials/scripts.ejs') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const alertBox = document.getElementById("alertBox");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          alertBox.style.display = "none";
          document.querySelectorAll(".error-text").forEach(el => (el.textContent = ""));

          const payload = {
            email: form.email.value.trim(),
            password: form.password.value
          };

          try {
            const res = await fetch("/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const data = await res.json();

            // ===== Field-specific validation errors =====
            if (data.errors && Array.isArray(data.errors)) {
              data.errors.forEach(err => {
                const safePath = err.path.replace(/\./g, '').replace(/\[/g,'').replace(/\]/g,'').replace(/[^a-zA-Z0-9]/g,'');
                const fieldError = document.getElementById("error-" + safePath);
                if (fieldError) fieldError.textContent = err.msg;
              });
              alertBox.className = "alert alert-danger text-center mt-3";
              alertBox.textContent = "Please fix the errors below.";
              alertBox.style.display = "block";
              return;
            }

            // ===== Successful login =====
            if (data.success) {
              alertBox.className = "alert alert-success text-center mt-3";
              alertBox.textContent = data.message;
              alertBox.style.display = "block";
              setTimeout(() => {
                window.location.href = data.redirect || "/dashboard";
              }, 1000);
              return;
            }

            // ===== Unexpected response =====
            alertBox.className = "alert alert-warning text-center mt-3";
            alertBox.textContent = "Unexpected response from server.";
            alertBox.style.display = "block";

          } catch (error) {
            console.error("‚ùå Fetch error:", error);
            alertBox.className = "alert alert-danger text-center mt-3";
            alertBox.textContent = "Something went wrong. Please try again.";
            alertBox.style.display = "block";
          }
        });
      });
    </script>

    <style>
      .error-text { font-size: 0.85rem; }
      .form-control:focus { box-shadow: none; }
    </style>
  </body>
</html>
