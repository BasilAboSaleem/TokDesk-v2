<!DOCTYPE html>
<html
  lang="en"
  class="dark-style customizer-hide"
  dir="ltr"
  data-theme="dark"
  data-assets-path="dashboard/assets/"
  data-template="vertical-menu-template-free"
>
  <%- include('../../partials/head.ejs') %>

  <body style="background-color: #121212;">
    <div class="authentication-wrapper authentication-basic min-vh-100 d-flex align-items-center justify-content-center">
      <div class="authentication-inner w-100" style="max-width: 550px;">
        <div class="card shadow-lg" style="background-color: #1e1e1e; color: #ffffff;">
          <div class="app-brand justify-content-center mb-4">
            <a href="/" class="app-brand-link gap-2 text-white">
              <span class="app-brand-text demo fw-bolder">TokDesk</span>
            </a>
          </div>

          <h4 class="mb-2 text-center">Adventure starts here üöÄ</h4>
          <p class="mb-4 text-center">Register your company to get started</p>

          <!-- Registration Form -->
          <form id="registerForm" class="mb-3" action="/auth/register-company" method="POST" enctype="multipart/form-data">
            <!-- Step 1 -->
            <div id="step1">
              <h4 class="mb-3">Company Details</h4>

              <div class="mb-3">
                <label for="companyName" class="form-label">Company Name</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="companyName" name="company[name]" required />
                <small class="text-danger error-text" id="error-companyName"></small>
              </div>

              <div class="mb-3">
                <label for="companyEmail" class="form-label">Company Email</label>
                <input type="email" class="form-control bg-dark text-white border-secondary" id="companyEmail" name="company[email]" required />
                <small class="text-danger error-text" id="error-companyEmail"></small>
              </div>

              <div class="mb-3">
                <label for="subdomain" class="form-label">Subdomain</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="subdomain" name="company[subdomain]" required />
                <small class="text-danger error-text" id="error-subdomain"></small>
              </div>

              <div class="mb-3">
                <label for="logo" class="form-label">Logo</label>
                <input type="file" class="form-control bg-dark text-white border-secondary" id="logo" name="logo" />
              </div>

              <button type="button" class="btn btn-primary w-100" id="toStep2">Next</button>
            </div>

            <!-- Step 2 -->
            <div id="step2" style="display:none;">
              <h4 class="mb-3">Admin Details</h4>

              <div class="mb-3">
                <label for="adminName" class="form-label">Admin Name</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="adminName" name="admin[name]" required />
                <small class="text-danger error-text" id="error-adminName"></small>
              </div>

              <div class="mb-3">
                <label for="adminEmail" class="form-label">Admin Email</label>
                <input type="email" class="form-control bg-dark text-white border-secondary" id="adminEmail" name="admin[email]" required />
                <small class="text-danger error-text" id="error-adminEmail"></small>
              </div>

              <div class="mb-3">
                <label class="form-label" for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control bg-dark text-white border-secondary" name="admin[password]" required />
                <small class="text-danger error-text" id="error-adminPassword"></small>
              </div>

              <div class="mb-3">
                <label class="form-label" for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" class="form-control bg-dark text-white border-secondary" name="admin[confirmPassword]" required />
                <small class="text-danger error-text" id="error-confirmPassword"></small>
              </div>

              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary w-45" id="backToStep1">Back</button>
                <button type="submit" class="btn btn-success w-45">Register</button>
              </div>
            </div>
          </form>

          <p class="text-center mt-3 text-white">
            <span>Already have an account?</span>
            <a href="/auth/login" class="fw-bold text-white">Sign in instead</a>
          </p>

          <div id="alertBox" class="alert text-center mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>

    <%- include('../../partials/scripts.ejs') %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const toStep2Btn = document.getElementById("toStep2");
    const backBtn = document.getElementById("backToStep1");
    const form = document.getElementById("registerForm");
    const alertBox = document.getElementById("alertBox");

    // === Step 1 Validation ===
    toStep2Btn.addEventListener("click", () => {
      const requiredFields = [
        { id: "companyName", msg: "Company name is required" },
        { id: "companyEmail", msg: "Company email is required" },
        { id: "subdomain", msg: "Subdomain is required" },
      ];

      let valid = true;
      requiredFields.forEach(f => {
        const input = document.getElementById(f.id);
        const errorField = document.getElementById("error-" + f.id);
        if (!input.value.trim()) {
          errorField.textContent = f.msg;
          valid = false;
        } else {
          errorField.textContent = "";
        }
      });

      if (valid) {
        step1.style.display = "none";
        step2.style.display = "block";
      }
    });

    // Back to Step 1
    backBtn.addEventListener("click", () => {
      step2.style.display = "none";
      step1.style.display = "block";
    });

    // === Handle Submission ===
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      alertBox.style.display = "none";
      document.querySelectorAll(".error-text").forEach(el => (el.textContent = ""));

      const formData = new FormData(form);

      try {
        const res = await fetch("/auth/register-company", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();

        // üîπ Handle Validation Errors
        if (data.errors && Array.isArray(data.errors)) {
          data.errors.forEach(err => {
            const safePath = err.path
              .replace(/\./g, '')
              .replace(/\[/g, '')
              .replace(/\]/g, '')
              .replace(/[^a-zA-Z0-9]/g, '');
            const fieldId = "error-" + safePath;
            const fieldError = document.getElementById(fieldId);
            if (fieldError) {
              fieldError.textContent = err.msg;
            } else {
              console.warn("‚ö†Ô∏è Unknown field from backend:", err.path);
            }
          });

          alertBox.className = "alert alert-danger text-center mt-3";
          alertBox.textContent = "Please fix the errors below.";
          alertBox.style.display = "block";
          return;
        }

        // üîπ Handle Successful Registration
        if (data.success) {
          alertBox.className = "alert alert-success text-center mt-3";
          alertBox.textContent = data.message;
          alertBox.style.display = "block";

          // Redirect ÿ®ÿπÿØ ŸÅÿ™ÿ±ÿ© ŸÇÿµŸäÿ±ÿ©
          setTimeout(() => {
            window.location.href = data.redirect || "/auth/login";
          }, 1500);
          return;
        }

        // üîπ Unexpected Response
        alertBox.className = "alert alert-warning text-center mt-3";
        alertBox.textContent = "Unexpected response from server.";
        alertBox.style.display = "block";

      } catch (error) {
        console.error("‚ùå Fetch error:", error);
        alertBox.className = "alert alert-danger text-center mt-3";
        alertBox.textContent = "Something went wrong. Please try again.";
        alertBox.style.display = "block";
      }
    });
  });
</script>




    <style>
      .error-text {
        font-size: 0.85rem;
      }
      .w-45 {
        width: 48%;
      }
      .form-control:focus {
        box-shadow: none;
      }
    </style>
  </body>
</html>
